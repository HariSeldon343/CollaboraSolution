<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test File Manager - CollaboraNexio</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica', Arial, sans-serif;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            background: #f3f4f6;
        }
        .test-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .test-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #1f2937;
        }
        .test-result {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .success {
            background: #d1fae5;
            color: #065f46;
        }
        .error {
            background: #fee2e2;
            color: #991b1b;
        }
        .warning {
            background: #fed7aa;
            color: #92400e;
        }
        .info {
            background: #dbeafe;
            color: #1e40af;
        }
        pre {
            background: #1f2937;
            color: #f9fafb;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #2563eb;
        }
    </style>
</head>
<body>
    <h1>Test File Manager - CollaboraNexio</h1>

    <div class="test-section">
        <div class="test-title">1. Verifica File JavaScript</div>
        <div id="jsTest"></div>
    </div>

    <div class="test-section">
        <div class="test-title">2. Verifica File CSS</div>
        <div id="cssTest"></div>
    </div>

    <div class="test-section">
        <div class="test-title">3. Test API Notifiche</div>
        <button onclick="testNotifications()">Test Endpoint Notifiche</button>
        <div id="notificationTest"></div>
    </div>

    <div class="test-section">
        <div class="test-title">4. Test Inizializzazione FileManager</div>
        <button onclick="testFileManager()">Inizializza FileManager</button>
        <div id="fileManagerTest"></div>
    </div>

    <div class="test-section">
        <div class="test-title">5. Console JavaScript</div>
        <pre id="consoleOutput"></pre>
    </div>

    <script>
        // Override console.error to capture errors
        const originalError = console.error;
        const consoleOutput = document.getElementById('consoleOutput');
        let consoleMessages = [];

        console.error = function(...args) {
            originalError.apply(console, args);
            consoleMessages.push('ERROR: ' + args.join(' '));
            updateConsole();
        };

        console.log = function(...args) {
            consoleMessages.push('LOG: ' + args.join(' '));
            updateConsole();
        };

        function updateConsole() {
            consoleOutput.textContent = consoleMessages.slice(-10).join('\n');
        }

        // Test JavaScript files
        function testJavaScript() {
            const jsTest = document.getElementById('jsTest');

            // Test app.js
            const appScript = document.createElement('script');
            appScript.src = 'assets/js/app.js';
            appScript.onload = () => {
                jsTest.innerHTML += '<div class="test-result success">✓ app.js caricato correttamente</div>';
            };
            appScript.onerror = () => {
                jsTest.innerHTML += '<div class="test-result error">✗ Errore nel caricamento di app.js</div>';
            };
            document.head.appendChild(appScript);

            // Test filemanager.js
            const fmScript = document.createElement('script');
            fmScript.src = 'assets/js/filemanager.js';
            fmScript.onload = () => {
                jsTest.innerHTML += '<div class="test-result success">✓ filemanager.js caricato correttamente</div>';

                // Check if FileManager class exists
                if (typeof FileManager !== 'undefined') {
                    jsTest.innerHTML += '<div class="test-result success">✓ Classe FileManager definita</div>';
                } else {
                    jsTest.innerHTML += '<div class="test-result error">✗ Classe FileManager non trovata</div>';
                }
            };
            fmScript.onerror = () => {
                jsTest.innerHTML += '<div class="test-result error">✗ Errore nel caricamento di filemanager.js</div>';
            };
            document.head.appendChild(fmScript);
        }

        // Test CSS files
        function testCSS() {
            const cssTest = document.getElementById('cssTest');

            const cssFiles = ['assets/css/styles.css', 'assets/css/filemanager.css'];

            cssFiles.forEach(file => {
                const link = document.createElement('link');
                link.rel = 'stylesheet';
                link.href = file;
                link.onload = () => {
                    cssTest.innerHTML += `<div class="test-result success">✓ ${file} caricato</div>`;
                };
                link.onerror = () => {
                    cssTest.innerHTML += `<div class="test-result error">✗ Errore: ${file}</div>`;
                };
                document.head.appendChild(link);
            });
        }

        // Test notifications endpoint
        async function testNotifications() {
            const testDiv = document.getElementById('notificationTest');
            testDiv.innerHTML = '<div class="test-result info">Testing...</div>';

            try {
                const response = await fetch('/CollaboraNexio/api/notifications/unread.php', {
                    credentials: 'same-origin',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    testDiv.innerHTML = `
                        <div class="test-result success">✓ Endpoint funziona (Status: ${response.status})</div>
                        <div class="test-result info">Risposta: ${JSON.stringify(data, null, 2)}</div>
                    `;
                } else {
                    testDiv.innerHTML = `
                        <div class="test-result warning">⚠ Status: ${response.status}</div>
                        <div class="test-result info">Risposta: ${JSON.stringify(data, null, 2)}</div>
                    `;
                }
            } catch (error) {
                testDiv.innerHTML = `<div class="test-result error">✗ Errore: ${error.message}</div>`;
            }
        }

        // Test FileManager initialization
        function testFileManager() {
            const testDiv = document.getElementById('fileManagerTest');

            try {
                if (typeof FileManager === 'undefined') {
                    testDiv.innerHTML = '<div class="test-result error">✗ FileManager non è definito. Caricare prima filemanager.js</div>';
                    return;
                }

                // Create minimal DOM structure
                const container = document.createElement('div');
                container.innerHTML = `
                    <div id="filesGrid"></div>
                    <div id="filesList"></div>
                    <div id="filesWrapper"></div>
                    <div id="dropZone"></div>
                `;
                document.body.appendChild(container);

                // Try to initialize FileManager
                const fm = new FileManager();

                testDiv.innerHTML = '<div class="test-result success">✓ FileManager inizializzato correttamente</div>';

                // Check state
                testDiv.innerHTML += `
                    <div class="test-result info">
                        State: currentPath="${fm.state.currentPath}",
                        currentView="${fm.state.currentView}",
                        selectedFiles=${fm.state.selectedFiles.size}
                    </div>
                `;

                // Clean up
                container.remove();

            } catch (error) {
                testDiv.innerHTML = `<div class="test-result error">✗ Errore inizializzazione: ${error.message}</div>`;
                console.error('FileManager init error:', error);
            }
        }

        // Run tests on page load
        window.addEventListener('DOMContentLoaded', () => {
            testJavaScript();
            testCSS();
        });

        // Check for syntax errors
        window.addEventListener('error', (e) => {
            const jsTest = document.getElementById('jsTest');
            if (e.filename && e.filename.includes('.js')) {
                jsTest.innerHTML += `
                    <div class="test-result error">
                        ✗ Errore JavaScript: ${e.message}<br>
                        File: ${e.filename}<br>
                        Linea: ${e.lineno}, Colonna: ${e.colno}
                    </div>
                `;
            }
        });
    </script>
</body>
</html>