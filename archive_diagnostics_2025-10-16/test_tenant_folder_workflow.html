<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Test Tenant Folder Creation Workflow</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        pre { background: #f4f4f4; padding: 10px; overflow-x: auto; }
        .status { font-weight: bold; }
    </style>
</head>
<body>
    <h1>Test Tenant Folder Creation Workflow</h1>
    
    <div class="test-section info">
        <h3>Test Overview</h3>
        <p>This will test the complete tenant folder creation workflow:</p>
        <ol>
            <li>Button click triggers modal</li>
            <li>Modal loads tenant list from API</li>
            <li>User selects tenant and enters folder name</li>
            <li>Form submission calls createRootFolder API</li>
            <li>Success message and file list refresh</li>
        </ol>
    </div>

    <div class="test-section">
        <h3>Step 1: Test API Endpoint Availability</h3>
        <button onclick="testApiEndpoint()">Test API Endpoint</button>
        <div id="step1-result"></div>
    </div>

    <div class="test-section">
        <h3>Step 2: Test Tenant List Loading</h3>
        <button onclick="testTenantList()">Load Tenant List</button>
        <div id="step2-result"></div>
    </div>

    <div class="test-section">
        <h3>Step 3: Test Create Root Folder API</h3>
        <label>Tenant ID: <input type="number" id="testTenantId" value="1"></label>
        <label>Folder Name: <input type="text" id="testFolderName" value="Test Folder"></label>
        <button onclick="testCreateRootFolder()">Create Test Folder</button>
        <div id="step3-result"></div>
    </div>

    <div class="test-section">
        <h3>Step 4: Workflow Trace</h3>
        <div id="workflow-trace"></div>
    </div>

    <script>
        // Get CSRF token (if available)
        let csrfToken = '';
        
        async function testApiEndpoint() {
            const resultDiv = document.getElementById('step1-result');
            resultDiv.innerHTML = '<p class="status">Testing...</p>';
            
            try {
                const response = await fetch('/CollaboraNexio/api/files_tenant.php?action=list', {
                    method: 'GET',
                    credentials: 'same-origin'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    resultDiv.innerHTML = `
                        <p class="status" style="color: green;">✓ API Endpoint is working!</p>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <p class="status" style="color: orange;">⚠ API returned error:</p>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <p class="status" style="color: red;">✗ Error: ${error.message}</p>
                `;
            }
        }

        async function testTenantList() {
            const resultDiv = document.getElementById('step2-result');
            resultDiv.innerHTML = '<p class="status">Loading tenants...</p>';
            
            try {
                const response = await fetch('/CollaboraNexio/api/tenants/list.php', {
                    method: 'GET',
                    credentials: 'same-origin'
                });
                
                const result = await response.json();
                
                if (result.success && result.data && result.data.tenants) {
                    resultDiv.innerHTML = `
                        <p class="status" style="color: green;">✓ Loaded ${result.data.tenants.length} tenant(s)!</p>
                        <pre>${JSON.stringify(result.data.tenants, null, 2)}</pre>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <p class="status" style="color: orange;">⚠ Unexpected response:</p>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <p class="status" style="color: red;">✗ Error: ${error.message}</p>
                `;
            }
        }

        async function testCreateRootFolder() {
            const resultDiv = document.getElementById('step3-result');
            const tenantId = document.getElementById('testTenantId').value;
            const folderName = document.getElementById('testFolderName').value;
            
            if (!folderName.trim()) {
                resultDiv.innerHTML = '<p style="color: red;">Please enter a folder name</p>';
                return;
            }
            
            resultDiv.innerHTML = '<p class="status">Creating folder...</p>';
            
            try {
                const response = await fetch('/CollaboraNexio/api/files_tenant.php?action=create_root_folder', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: folderName,
                        tenant_id: tenantId,
                        csrf_token: csrfToken
                    }),
                    credentials: 'same-origin'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    resultDiv.innerHTML = `
                        <p class="status" style="color: green;">✓ Folder created successfully!</p>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <p class="status" style="color: orange;">⚠ Error: ${result.error || 'Unknown error'}</p>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <p class="status" style="color: red;">✗ Error: ${error.message}</p>
                `;
            }
        }

        // Trace workflow
        function traceWorkflow() {
            const traceDiv = document.getElementById('workflow-trace');
            
            traceDiv.innerHTML = `
                <h4>Workflow Components Analysis:</h4>
                <ul>
                    <li><strong>Button:</strong> #createRootFolderBtn (lines.php:368)</li>
                    <li><strong>Event Listener:</strong> filemanager_enhanced.js:63-65</li>
                    <li><strong>Modal Show Method:</strong> showCreateTenantFolderModal() (lines 2216-2232)</li>
                    <li><strong>Tenant Loading:</strong> loadTenantOptions() (lines 2234-2275)</li>
                    <li><strong>Modal HTML:</strong> createTenantFolderModal (files.php:648)</li>
                    <li><strong>Submit Button:</strong> onclick="createTenantFolder()" (files.php:675)</li>
                    <li><strong>Submit Handler:</strong> createTenantFolder() (files.php:856)</li>
                    <li><strong>API Call Method:</strong> createRootFolder() (lines 2277-2307)</li>
                    <li><strong>API Endpoint:</strong> /api/files_tenant.php?action=create_root_folder</li>
                    <li><strong>API Handler:</strong> createRootFolder() function (files_tenant.php:256-329)</li>
                </ul>
                
                <h4>Expected Flow:</h4>
                <ol>
                    <li>Click "Cartella Tenant" button → showCreateTenantFolderModal()</li>
                    <li>Modal opens → loadTenantOptions() fetches from /api/tenants/list.php</li>
                    <li>User selects tenant + enters folder name</li>
                    <li>Click "Crea Cartella" → createTenantFolder() (inline function)</li>
                    <li>Calls fileManager.createRootFolder(folderName, tenantId)</li>
                    <li>POST to /api/files_tenant.php?action=create_root_folder</li>
                    <li>API inserts into files table with is_folder=1, folder_id=NULL</li>
                    <li>Success → Close modal + refresh file list</li>
                </ol>
            `;
        }
        
        // Run trace on load
        traceWorkflow();
    </script>
</body>
</html>
