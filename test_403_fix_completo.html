<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Fix 403 Forbidden - CollaboraNexio</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .fix-status {
            background: #4CAF50;
            color: white;
            padding: 20px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
        }

        .fix-status.error {
            background: #f44336;
        }

        .content {
            padding: 30px;
        }

        .test-section {
            margin-bottom: 30px;
        }

        .test-section h2 {
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .test-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s ease;
        }

        .test-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .test-card.success {
            border-left: 4px solid #4CAF50;
        }

        .test-card.error {
            border-left: 4px solid #f44336;
        }

        .test-card.pending {
            border-left: 4px solid #ff9800;
        }

        .test-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }

        .test-status {
            font-size: 14px;
            color: #666;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 16px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .console {
            background: #2b2b2b;
            color: #f1f1f1;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .console-line {
            margin: 5px 0;
            line-height: 1.4;
        }

        .console-line.success {
            color: #4CAF50;
        }

        .console-line.error {
            color: #f44336;
        }

        .console-line.warning {
            color: #ff9800;
        }

        .console-line.info {
            color: #2196F3;
        }

        .status-icon {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
            vertical-align: middle;
        }

        .status-icon.success {
            background: #4CAF50;
        }

        .status-icon.error {
            background: #f44336;
        }

        .status-icon.pending {
            background: #ff9800;
        }

        .progress-bar {
            background: #f0f0f0;
            height: 30px;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .test-results {
            margin-top: 30px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîß Test Fix 403 Forbidden</h1>
            <p>Verifica completa del fix per BUG-010 (403 con Query String)</p>
        </div>

        <div class="fix-status" id="fixStatus">
            ‚úÖ FIX APPLICATO - Versione .htaccess aggiornata con END flag
        </div>

        <div class="content">
            <div class="alert info">
                <strong>‚ÑπÔ∏è Informazione:</strong> Questo test verifica che gli endpoint API funzionino correttamente con e senza query string parameters.
                Il problema originale causava errore 403 Forbidden quando venivano aggiunti parametri query come ?_t=timestamp per il cache busting.
            </div>

            <div class="test-section">
                <h2>üß™ Test Automatici</h2>
                <button class="btn" onclick="runAllTests()">‚ñ∂Ô∏è Esegui Tutti i Test</button>
                <button class="btn" onclick="clearConsole()">üóëÔ∏è Pulisci Console</button>
                <button class="btn" onclick="location.reload()">üîÑ Ricarica Pagina</button>

                <div class="progress-bar">
                    <div class="progress-fill" id="progressBar" style="width: 0%">0%</div>
                </div>

                <div class="test-grid" id="testGrid">
                    <!-- Test cards will be inserted here -->
                </div>
            </div>

            <div class="test-section">
                <h2>üìä Risultati Test</h2>
                <div id="testResults"></div>
            </div>

            <div class="test-section">
                <h2>üñ•Ô∏è Console Output</h2>
                <div class="console" id="console">
                    <div class="console-line info">Console pronta. Clicca "Esegui Tutti i Test" per iniziare.</div>
                </div>
            </div>

            <div class="test-section">
                <h2>üìù Dettagli Tecnici del Fix</h2>
                <div class="alert success">
                    <strong>‚úÖ Fix Applicato:</strong><br><br>
                    Il file <code>/api/.htaccess</code> √® stato aggiornato per utilizzare il flag [END] invece di [L] nelle regole di rewrite.
                    Questo previene conflitti con le query string e risolve l'errore 403 Forbidden.<br><br>
                    <strong>Modifiche chiave:</strong>
                    <ul style="margin-top: 10px; margin-left: 20px;">
                        <li>Sostituito flag [L,QSA] con [END] per stop completo del processing</li>
                        <li>Semplificato pattern matching usando .* invece di ^</li>
                        <li>Mantenuta priorit√† alta per /api/files/ endpoints</li>
                        <li>Backup originale salvato come .htaccess.backup_403_fix</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        const tests = [
            {
                name: 'Upload senza query string',
                url: '/CollaboraNexio/api/files/upload.php',
                method: 'POST',
                expectedStatus: 401
            },
            {
                name: 'Upload CON query string',
                url: '/CollaboraNexio/api/files/upload.php?_t=' + Date.now(),
                method: 'POST',
                expectedStatus: 401
            },
            {
                name: 'Create Document senza query',
                url: '/CollaboraNexio/api/files/create_document.php',
                method: 'POST',
                expectedStatus: 401
            },
            {
                name: 'Create Document CON query',
                url: '/CollaboraNexio/api/files/create_document.php?_t=' + Date.now(),
                method: 'POST',
                expectedStatus: 401
            },
            {
                name: 'List Files (GET test)',
                url: '/CollaboraNexio/api/files/list.php',
                method: 'GET',
                expectedStatus: 401
            },
            {
                name: 'List Files con query (GET)',
                url: '/CollaboraNexio/api/files/list.php?folder_id=0',
                method: 'GET',
                expectedStatus: 401
            }
        ];

        let testResults = [];

        function addConsoleLog(message, type = 'info') {
            const console = document.getElementById('console');
            const line = document.createElement('div');
            line.className = `console-line ${type}`;

            const time = new Date().toLocaleTimeString();
            line.innerHTML = `[${time}] ${message}`;

            console.appendChild(line);
            console.scrollTop = console.scrollHeight;
        }

        function clearConsole() {
            document.getElementById('console').innerHTML = '';
            addConsoleLog('Console pulita', 'info');
        }

        function updateProgressBar(current, total) {
            const percentage = Math.round((current / total) * 100);
            const bar = document.getElementById('progressBar');
            bar.style.width = percentage + '%';
            bar.textContent = percentage + '%';
        }

        function createTestCard(test, index) {
            return `
                <div class="test-card pending" id="test-${index}">
                    <span class="status-icon pending"></span>
                    <div class="test-title">${test.name}</div>
                    <div class="test-status">In attesa...</div>
                </div>
            `;
        }

        function updateTestCard(index, status, message) {
            const card = document.getElementById(`test-${index}`);
            const statusClass = status === 'success' ? 'success' : 'error';

            card.className = `test-card ${statusClass}`;
            card.querySelector('.status-icon').className = `status-icon ${statusClass}`;
            card.querySelector('.test-status').textContent = message;
        }

        async function runTest(test, index) {
            addConsoleLog(`Esecuzione test: ${test.name}`, 'info');
            addConsoleLog(`${test.method} ${test.url}`, 'info');

            try {
                const response = await fetch(test.url, {
                    method: test.method,
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: test.method === 'POST' ? JSON.stringify({test: true}) : undefined
                });

                const status = response.status;
                const success = status === test.expectedStatus;

                if (success) {
                    addConsoleLog(`‚úÖ Test PASSATO: Status ${status} (atteso ${test.expectedStatus})`, 'success');
                    updateTestCard(index, 'success', `Status ${status} - OK`);
                } else {
                    addConsoleLog(`‚ùå Test FALLITO: Status ${status} (atteso ${test.expectedStatus})`, 'error');
                    updateTestCard(index, 'error', `Status ${status} - ERRORE`);
                }

                return {
                    test: test.name,
                    url: test.url,
                    method: test.method,
                    expectedStatus: test.expectedStatus,
                    actualStatus: status,
                    success: success
                };

            } catch (error) {
                addConsoleLog(`‚ùå Errore durante il test: ${error.message}`, 'error');
                updateTestCard(index, 'error', 'Errore di rete');

                return {
                    test: test.name,
                    url: test.url,
                    method: test.method,
                    expectedStatus: test.expectedStatus,
                    actualStatus: 'ERROR',
                    success: false,
                    error: error.message
                };
            }
        }

        async function runAllTests() {
            addConsoleLog('=== INIZIO TEST SUITE ===', 'info');
            testResults = [];

            // Disable button during tests
            document.querySelector('.btn').disabled = true;

            for (let i = 0; i < tests.length; i++) {
                updateProgressBar(i, tests.length);
                const result = await runTest(tests[i], i);
                testResults.push(result);
                await new Promise(resolve => setTimeout(resolve, 500)); // Small delay between tests
            }

            updateProgressBar(tests.length, tests.length);

            // Re-enable button
            document.querySelector('.btn').disabled = false;

            displayResults();
            addConsoleLog('=== TEST COMPLETATI ===', 'info');
        }

        function displayResults() {
            const successCount = testResults.filter(r => r.success).length;
            const failCount = testResults.filter(r => !r.success).length;
            const total = testResults.length;

            const resultsDiv = document.getElementById('testResults');

            let html = '';

            if (failCount === 0) {
                html += '<div class="alert success">';
                html += `<strong>‚úÖ TUTTI I TEST PASSATI!</strong><br>`;
                html += `${successCount} su ${total} test completati con successo.<br>`;
                html += `Il problema 403 Forbidden √® stato RISOLTO COMPLETAMENTE!`;
                html += '</div>';

                document.getElementById('fixStatus').className = 'fix-status';
                document.getElementById('fixStatus').innerHTML = '‚úÖ FIX VERIFICATO - Sistema funzionante al 100%';
            } else {
                html += '<div class="alert error">';
                html += `<strong>‚ö†Ô∏è ALCUNI TEST FALLITI</strong><br>`;
                html += `${successCount} passati, ${failCount} falliti su ${total} test totali.<br>`;
                html += `Potrebbero esserci ancora problemi da risolvere.`;
                html += '</div>';

                document.getElementById('fixStatus').className = 'fix-status error';
                document.getElementById('fixStatus').innerHTML = '‚ùå PROBLEMA PERSISTENTE - Alcuni test ancora falliscono';
            }

            html += '<table>';
            html += '<thead><tr>';
            html += '<th>Test</th>';
            html += '<th>Metodo</th>';
            html += '<th>Status Atteso</th>';
            html += '<th>Status Ricevuto</th>';
            html += '<th>Risultato</th>';
            html += '</tr></thead>';
            html += '<tbody>';

            testResults.forEach(result => {
                const icon = result.success ? '‚úÖ' : '‚ùå';
                const rowClass = result.success ? '' : 'style="background: #ffe0e0"';

                html += `<tr ${rowClass}>`;
                html += `<td>${result.test}</td>`;
                html += `<td>${result.method}</td>`;
                html += `<td>${result.expectedStatus}</td>`;
                html += `<td>${result.actualStatus}</td>`;
                html += `<td>${icon} ${result.success ? 'PASS' : 'FAIL'}</td>`;
                html += '</tr>';
            });

            html += '</tbody></table>';

            resultsDiv.innerHTML = html;
        }

        // Initialize test cards
        document.addEventListener('DOMContentLoaded', () => {
            const grid = document.getElementById('testGrid');
            tests.forEach((test, index) => {
                grid.innerHTML += createTestCard(test, index);
            });

            addConsoleLog('Sistema di test inizializzato', 'success');
            addConsoleLog(`Pronti ${tests.length} test da eseguire`, 'info');
        });
    </script>
</body>
</html>