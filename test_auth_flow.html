<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authentication Flow Test - CollaboraNexio</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 5px;
        }
        .test-section h2 {
            margin-top: 0;
            color: #667eea;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #5a67d8;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 5px;
            border-left: 4px solid #667eea;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .success {
            border-left-color: #48bb78;
            background: #f0fff4;
        }
        .error {
            border-left-color: #f56565;
            background: #fff5f5;
        }
        .info {
            border-left-color: #4299e1;
            background: #f0f9ff;
        }
        input {
            padding: 8px 12px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 200px;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .status-authenticated {
            background: #48bb78;
        }
        .status-unauthenticated {
            background: #f56565;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê CollaboraNexio - Authentication Flow Test</h1>

        <div class="test-section">
            <h2>1. Check Current Session Status</h2>
            <p>Check if there's an active session and view session details.</p>
            <button onclick="checkSession()">Check Session Status</button>
            <button onclick="checkSessionConsistency()">Check Session Consistency</button>
            <div id="sessionResult" class="result info" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h2>2. Test Login via auth_api.php</h2>
            <p>Test the authentication endpoint that uses centralized session configuration.</p>
            <input type="email" id="authApiEmail" placeholder="Email" value="admin@demo.local">
            <input type="password" id="authApiPassword" placeholder="Password" value="Admin123!">
            <br>
            <button onclick="loginViaAuthApi()">Login via auth_api.php</button>
            <div id="authApiResult" class="result" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h2>3. Test Login via api/auth.php</h2>
            <p>Test the alternative authentication endpoint.</p>
            <input type="email" id="apiAuthEmail" placeholder="Email" value="admin@demo.local">
            <input type="password" id="apiAuthPassword" placeholder="Password" value="Admin123!">
            <br>
            <button onclick="loginViaApiAuth()">Login via api/auth.php</button>
            <div id="apiAuthResult" class="result" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h2>4. Test Dashboard Access</h2>
            <p>Check if the session is recognized by dashboard.php.</p>
            <button onclick="testDashboardAccess()">Test Dashboard Access</button>
            <button onclick="window.open('/CollaboraNexio/dashboard.php', '_blank')">Open Dashboard in New Tab</button>
            <div id="dashboardResult" class="result" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h2>5. Test Logout</h2>
            <p>Test session destruction and cookie cleanup.</p>
            <button onclick="logoutViaAuthApi()">Logout via auth_api.php</button>
            <button onclick="logoutViaApiAuth()">Logout via api/auth.php</button>
            <div id="logoutResult" class="result" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h2>6. Cookie Inspector</h2>
            <p>View all cookies for this domain.</p>
            <button onclick="inspectCookies()">Inspect Cookies</button>
            <div id="cookieResult" class="result info" style="display:none;"></div>
        </div>
    </div>

    <script>
        // Base URL for API calls
        const BASE_URL = window.location.origin + '/CollaboraNexio';

        // Helper function to display results
        function displayResult(elementId, data, type = 'info') {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.className = 'result ' + type;

            if (typeof data === 'object') {
                element.textContent = JSON.stringify(data, null, 2);
            } else {
                element.textContent = data;
            }
        }

        // 1. Check Session Status
        async function checkSession() {
            try {
                const response = await fetch(`${BASE_URL}/auth_api.php?action=session`, {
                    credentials: 'include'
                });
                const data = await response.json();

                const isAuthenticated = data.session_data && data.session_data.user_id;
                const statusText = isAuthenticated ? '‚úÖ Authenticated' : '‚ùå Not Authenticated';

                displayResult('sessionResult', {
                    status: statusText,
                    session_id: data.session_id,
                    session_data: data.session_data,
                    response: data
                }, isAuthenticated ? 'success' : 'info');
            } catch (error) {
                displayResult('sessionResult', 'Error: ' + error.message, 'error');
            }
        }

        // Check Session Consistency
        async function checkSessionConsistency() {
            try {
                const response = await fetch(`${BASE_URL}/test_session_consistency.php`, {
                    credentials: 'include'
                });
                const data = await response.json();

                const hasIssues = data.recommendations && data.recommendations.length > 0;
                displayResult('sessionResult', data, hasIssues ? 'error' : 'success');
            } catch (error) {
                displayResult('sessionResult', 'Error: ' + error.message, 'error');
            }
        }

        // 2. Login via auth_api.php
        async function loginViaAuthApi() {
            const email = document.getElementById('authApiEmail').value;
            const password = document.getElementById('authApiPassword').value;

            try {
                const response = await fetch(`${BASE_URL}/auth_api.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password }),
                    credentials: 'include'
                });

                const data = await response.json();
                displayResult('authApiResult', data, data.success ? 'success' : 'error');

                // Automatically check session after login
                if (data.success) {
                    setTimeout(() => checkSession(), 500);
                }
            } catch (error) {
                displayResult('authApiResult', 'Error: ' + error.message, 'error');
            }
        }

        // 3. Login via api/auth.php
        async function loginViaApiAuth() {
            const email = document.getElementById('apiAuthEmail').value;
            const password = document.getElementById('apiAuthPassword').value;

            try {
                const response = await fetch(`${BASE_URL}/api/auth.php?action=login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password }),
                    credentials: 'include'
                });

                const data = await response.json();
                displayResult('apiAuthResult', data, data.success ? 'success' : 'error');

                // Automatically check session after login
                if (data.success) {
                    setTimeout(() => checkSession(), 500);
                }
            } catch (error) {
                displayResult('apiAuthResult', 'Error: ' + error.message, 'error');
            }
        }

        // 4. Test Dashboard Access
        async function testDashboardAccess() {
            try {
                const response = await fetch(`${BASE_URL}/dashboard.php`, {
                    credentials: 'include',
                    redirect: 'manual'
                });

                let result = {
                    status: response.status,
                    statusText: response.statusText,
                    redirected: response.type === 'opaqueredirect',
                    headers: {}
                };

                // Check if redirected (302 to login)
                if (response.status === 0 || response.type === 'opaqueredirect') {
                    result.message = '‚ùå Redirected to login - Session not recognized';
                    displayResult('dashboardResult', result, 'error');
                } else if (response.status === 200) {
                    result.message = '‚úÖ Dashboard accessible - Session is valid';
                    displayResult('dashboardResult', result, 'success');
                } else {
                    result.message = `‚ö†Ô∏è Unexpected status: ${response.status}`;
                    displayResult('dashboardResult', result, 'error');
                }
            } catch (error) {
                displayResult('dashboardResult', 'Error: ' + error.message, 'error');
            }
        }

        // 5. Logout Functions
        async function logoutViaAuthApi() {
            try {
                const response = await fetch(`${BASE_URL}/auth_api.php?action=logout`, {
                    credentials: 'include'
                });
                const data = await response.json();
                displayResult('logoutResult', data, data.success ? 'success' : 'error');

                // Check session after logout
                setTimeout(() => checkSession(), 500);
            } catch (error) {
                displayResult('logoutResult', 'Error: ' + error.message, 'error');
            }
        }

        async function logoutViaApiAuth() {
            try {
                const response = await fetch(`${BASE_URL}/api/auth.php?action=logout`, {
                    credentials: 'include'
                });
                const data = await response.json();
                displayResult('logoutResult', data, data.success ? 'success' : 'error');

                // Check session after logout
                setTimeout(() => checkSession(), 500);
            } catch (error) {
                displayResult('logoutResult', 'Error: ' + error.message, 'error');
            }
        }

        // 6. Cookie Inspector
        function inspectCookies() {
            const cookies = document.cookie.split(';').map(c => c.trim());
            const cookieData = {};

            cookies.forEach(cookie => {
                const [name, value] = cookie.split('=');
                if (name) {
                    cookieData[name] = value;
                }
            });

            const result = {
                raw_cookies: document.cookie || 'No cookies found',
                parsed_cookies: cookieData,
                has_COLLAB_SID: 'COLLAB_SID' in cookieData,
                has_PHPSESSID: 'PHPSESSID' in cookieData,
                recommendation: ''
            };

            if (result.has_PHPSESSID && !result.has_COLLAB_SID) {
                result.recommendation = 'Old PHPSESSID cookie found. Clear cookies and try again.';
            } else if (result.has_COLLAB_SID) {
                result.recommendation = 'COLLAB_SID cookie found - Session should work correctly.';
            } else {
                result.recommendation = 'No session cookie found - Login required.';
            }

            displayResult('cookieResult', result, 'info');
        }

        // Auto-check session on page load
        window.addEventListener('DOMContentLoaded', () => {
            checkSession();
            inspectCookies();
        });
    </script>
</body>
</html>